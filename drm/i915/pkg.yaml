name: i915
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: base
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/kernel:{{ .BUILD_ARG_PKGS }}"

steps:
  - prepare:
      - |
        apk add --no-cache wget dpkg build-base
  - install:
      - |
        set -x
        # Get kernel release version
        export KERNELRELEASE=$(find /lib/modules -type d -name "*-talos" -exec basename {} \+)

        # Get the source
        wget https://github.com/strongtz/i915-sriov-dkms/releases/download/2024.12.30/i915-sriov-dkms_2024.12.30_amd64.deb
        dpkg -x i915-sriov-dkms_2024.12.30_amd64.deb /tmp/extract

        # Create module directories
        mkdir -p /rootfs/lib/modules/${KERNELRELEASE}/extra
        mkdir -p /rootfs/etc/modprobe.d
        mkdir -p /rootfs/etc/modules-load.d

        # Build the module against Talos kernel
        cd /tmp/extract/usr/src/i915-sriov-dkms-2024.12.30
        make -C /lib/modules/${KERNELRELEASE}/build M=$(pwd) modules

        # Install the module
        install -D drivers/gpu/drm/i915/i915.ko /rootfs/lib/modules/${KERNELRELEASE}/extra/i915.ko

        # Set up configuration
        echo "options i915 enable_guc=3" > /rootfs/etc/modprobe.d/i915-sriov.conf
        echo "i915" > /rootfs/etc/modules-load.d/i915.conf

        # Run depmod to generate dependencies
        depmod -b /rootfs ${KERNELRELEASE}

finalize:
  - from: /rootfs
    to: /rootfs
  - from: /pkg/manifest.yaml
    to: /
